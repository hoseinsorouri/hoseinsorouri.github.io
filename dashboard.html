<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>مدیریت فرم بدنسازی</title>
    <!-- Tabler CSS -->
    <link href="https://cdn.jsdelivr.net/npm/@tabler/core@1.0.0-beta17/dist/css/tabler.min.css" rel="stylesheet">
    <!-- Tabler Icons -->
    <link href="https://cdn.jsdelivr.net/npm/@tabler/icons@2.47.0/iconfont/tabler-icons.min.css" rel="stylesheet">
    <!-- Quill CSS -->
    <link href="https://cdn.jsdelivr.net/npm/quill@2.0.2/dist/quill.snow.css" rel="stylesheet">
    <style>
        body { background: #f8f9fa; font-family: Arial, sans-serif; }
        .container { max-width: 1200px; margin: auto; padding: 20px; }
        .modal-content { max-height: 80vh; overflow-y: auto; }
        .grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; text-align: right; }
        .grid div { padding: 5px; }
        .grid img { max-width: 200px; display: block; margin: 0 auto; }
        .notebook-content { background: #fff; padding: 20px; border-radius: 8px; }
        #editor { border: 1px solid #ddd; min-height: 300px; text-align: right; }
        .print-controls { margin-top: 10px; text-align: center; }
        .textarea-add { width: 100%; height: 200px; margin-bottom: 10px; }
        .page-nav { display: flex; align-items: center; justify-content: center; gap: 10px; }
        .page-nav .page-number { font-weight: bold; }
        footer { text-align: center; margin-top: 20px; }
        .table th, .table td { text-align: center; vertical-align: middle; }
        .nav-tabs { margin-bottom: 20px; }
        .alert { position: fixed; top: 20px; right: 20px; z-index: 1000; }
        /* Dark Mode Styles */
        .dark-mode { background: #222529; color: #ffffff; }
        .dark-mode .card { background: #2c3034; }
        .dark-mode .modal-content { background: #2c3034; }
        .dark-mode .form-control, .dark-mode .form-select { background: #343a40; color: #ffffff; border-color: #444; }
        .dark-mode .notebook-content { background: #2c3034; }
        .dark-mode #editor { background: #343a40; color: #ffffff; }
        .dark-mode .table { background: #2c3034; color: #ffffff; }
        .dark-mode .btn-outline-secondary { border-color: #444; color: #ffffff; }
        .dark-mode .btn-outline-secondary:hover { background: #444; }
    </style>
</head>
<body>
    <!-- Main Container -->
    <div class="container">
        <!-- Header with Search and Buttons -->
        <div class="row mb-3">
            <div class="col-md-6">
                <div class="input-icon">
                    <input type="text" id="searchInput" class="form-control" placeholder="جستجو بر اساس نام یا شماره تلفن...">
                    <span class="input-icon-addon"><i class="ti ti-search"></i></span>
                </div>
            </div>
            <div class="col-md-6 text-end">
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addModal">
                    <i class="ti ti-plus me-1"></i> افزودن دستی
                </button>
                <button class="btn btn-secondary" id="settingsBtn">
                    <i class="ti ti-settings me-1"></i> تنظیمات
                </button>
                <button class="btn btn-secondary" id="toggleDarkMode">
                    <i class="ti ti-moon me-1"></i> حالت تاریک
                </button>
            </div>
        </div>
        <!-- Users Table -->
        <div class="card">
            <div class="table-responsive">
                <table class="table table-vcenter">
                    <thead>
                        <tr>
                            <th>ردیف</th>
                            <th>نام کامل</th>
                            <th>شماره تلفن</th>
                            <th>متد تماس</th>
                            <th>تاریخ و ساعت درخواست</th>
                            <th>عملیات</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody"></tbody>
                </table>
            </div>
        </div>

        <!-- Modal for Details -->
        <div class="modal fade" id="detailsModal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">جزئیات کاربر</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div id="modalContent" class="grid"></div>
                        <footer>تاریخ درخواست: <span id="requestDate"></span></footer>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-warning" onclick="editUser(currentUserIndex)">
                            <i class="ti ti-edit me-1"></i> ویرایش
                        </button>
                        <button class="btn btn-danger" onclick="deleteUser(currentUserIndex)">
                            <i class="ti ti-trash me-1"></i> حذف
                        </button>
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">بستن</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal for Adding Data -->
        <div class="modal fade" id="addModal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">افزودن دستی اطلاعات</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <ul class="nav nav-tabs">
                            <li class="nav-item">
                                <a class="nav-link active" data-bs-toggle="tab" href="#addByText">ورود با متن</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" data-bs-toggle="tab" href="#addByForm">ورود با فرم</a>
                            </li>
                        </ul>
                        <div class="tab-content">
                            <!-- Tab for Textarea -->
                            <div class="tab-pane fade show active" id="addByText">
                                <textarea id="addTextarea" class="form-control textarea-add" placeholder="متن را اینجا پیست کنید..."></textarea>
                                <button id="addDataBtn" class="btn btn-primary mt-2">
                                    <i class="ti ti-check me-1"></i> افزودن
                                </button>
                            </div>
                            <!-- Tab for Form -->
                            <div class="tab-pane fade" id="addByForm">
                                <form id="addForm" class="row g-3">
                                    <div class="col-md-6">
                                        <label class="form-label">نام</label>
                                        <input type="text" id="addFirstName" class="form-control">
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">نام خانوادگی</label>
                                        <input type="text" id="addLastName" class="form-control">
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">تاریخ تولد</label>
                                        <input type="text" id="addBirthDate" class="form-control" placeholder="مثال: ۱۳۷۰/۰۳/۲۳">
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">شماره تلفن</label>
                                        <input type="text" id="addPhone" class="form-control">
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">متد تماس</label>
                                        <select id="addContactMethod" class="form-select">
                                            <option value="telegram">تلگرام</option>
                                            <option value="whatsapp">واتساپ</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">جنسیت</label>
                                        <select id="addGender" class="form-select">
                                            <option value="male">مرد</option>
                                            <option value="female">زن</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">وزن (کیلوگرم)</label>
                                        <input type="text" id="addWeight" class="form-control">
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">قد (سانتی‌متر)</label>
                                        <input type="text" id="addHeight" class="form-control">
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">دور ران (سانتی‌متر)</label>
                                        <input type="text" id="addThigh" class="form-control">
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">دور شکم (سانتی‌متر)</label>
                                        <input type="text" id="addAbdomen" class="form-control">
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">دور باسن (سانتی‌متر)</label>
                                        <input type="text" id="addHip" class="form-control">
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">دور سینه (سانتی‌متر)</label>
                                        <input type="text" id="addChest" class="form-control">
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">دور بازو (سانتی‌متر)</label>
                                        <input type="text" id="addArm" class="form-control">
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">سابقه بیماری</label>
                                        <select id="addQ1" class="form-select">
                                            <option value="true">بله</option>
                                            <option value="false">خیر</option>
                                        </select>
                                    </div>
                                    <div class="col-md-12">
                                        <label class="form-label">جزئیات بیماری</label>
                                        <textarea id="addHeartDetails" class="form-control"></textarea>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">استفاده از مکمل</label>
                                        <select id="addSupplement1" class="form-select">
                                            <option value="true">بله</option>
                                            <option value="false">خیر</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">نوع مکمل</label>
                                        <input type="text" id="addOtherSupplement" class="form-control">
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">اطلاعات مکمل</label>
                                        <select id="addWantSupplementInfo" class="form-select">
                                            <option value="true">بله</option>
                                            <option value="false">خیر</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">قصد خرید</label>
                                        <select id="addWantToPurchase" class="form-select">
                                            <option value="true">بله</option>
                                            <option value="false">خیر</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">بودجه</label>
                                        <select id="addBudget" class="form-select">
                                            <option value="">انتخاب کنید</option>
                                            <option value="low">کمتر از ۵۰۰ هزار تومان</option>
                                            <option value="medium">۵۰۰ هزار تا ۱ میلیون تومان</option>
                                            <option value="high">۱ تا ۲ میلیون تومان</option>
                                            <option value="veryHigh">بیش از ۲ میلیون تومان</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">هدف</label>
                                        <select id="addGoal" class="form-select">
                                            <option value="">انتخاب کنید</option>
                                            <option value="muscleGain">افزایش حجم عضلانی</option>
                                            <option value="fatLoss">چربی سوزی</option>
                                            <option value="recovery">ریکاوری بهتر</option>
                                            <option value="performance">بهبود عملکرد</option>
                                            <option value="health">سلامت عمومی</option>
                                        </select>
                                    </div>
                                    <div class="col-md-12">
                                        <label class="form-label">توضیحات</label>
                                        <textarea id="addDdoso" class="form-control"></textarea>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">آدرس عکس تمام‌رخ</label>
                                        <input type="url" id="addFrontPhoto" class="form-control" placeholder="https://example.com/photo.jpg">
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">آدرس عکس نیم‌رخ</label>
                                        <input type="url" id="addSidePhoto" class="form-control" placeholder="https://example.com/photo.jpg">
                                    </div>
                                </form>
                                <button id="addFormBtn" class="btn btn-primary mt-2">
                                    <i class="ti ti-check me-1"></i> افزودن
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal for Editing Data -->
        <div class="modal fade" id="editModal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">ویرایش اطلاعات کاربر</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <form id="editForm" class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">نام</label>
                                <input type="text" id="editFirstName" class="form-control">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">نام خانوادگی</label>
                                <input type="text" id="editLastName" class="form-control">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">تاریخ تولد</label>
                                <input type="text" id="editBirthDate" class="form-control" placeholder="مثال: ۱۳۷۰/۰۳/۲۳">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">شماره تلفن</label>
                                <input type="text" id="editPhone" class="form-control">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">متد تماس</label>
                                <select id="editContactMethod" class="form-select">
                                    <option value="telegram">تلگرام</option>
                                    <option value="whatsapp">واتساپ</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">جنسیت</label>
                                <select id="editGender" class="form-select">
                                    <option value="male">مرد</option>
                                    <option value="female">زن</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">وزن (کیلوگرم)</label>
                                <input type="text" id="editWeight" class="form-control">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">قد (سانتی‌متر)</label>
                                <input type="text" id="editHeight" class="form-control">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">دور ران (سانتی‌متر)</label>
                                <input type="text" id="editThigh" class="form-control">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">دور شکم (سانتی‌متر)</label>
                                <input type="text" id="editAbdomen" class="form-control">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">دور باسن (سانتی‌متر)</label>
                                <input type="text" id="editHip" class="form-control">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">دور سینه (سانتی‌متر)</label>
                                <input type="text" id="editChest" class="form-control">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">دور بازو (سانتی‌متر)</label>
                                <input type="text" id="editArm" class="form-control">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">سابقه بیماری</label>
                                <select id="editQ1" class="form-select">
                                    <option value="true">بله</option>
                                    <option value="false">خیر</option>
                                </select>
                            </div>
                            <div class="col-md-12">
                                <label class="form-label">جزئیات بیماری</label>
                                <textarea id="editHeartDetails" class="form-control"></textarea>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">استفاده از مکمل</label>
                                <select id="editSupplement1" class="form-select">
                                    <option value="true">بله</option>
                                    <option value="false">خیر</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">نوع مکمل</label>
                                <input type="text" id="editOtherSupplement" class="form-control">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">اطلاعات مکمل</label>
                                <select id="editWantSupplementInfo" class="form-select">
                                    <option value="true">بله</option>
                                    <option value="false">خیر</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">قصد خرید</label>
                                <select id="editWantToPurchase" class="form-select">
                                    <option value="true">بله</option>
                                    <option value="false">خیر</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">بودجه</label>
                                <select id="editBudget" class="form-select">
                                    <option value="">انتخاب کنید</option>
                                    <option value="low">کمتر از ۵۰۰ هزار تومان</option>
                                    <option value="medium">۵۰۰ هزار تا ۱ میلیون تومان</option>
                                    <option value="high">۱ تا ۲ میلیون تومان</option>
                                    <option value="veryHigh">بیش از ۲ میلیون تومان</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">هدف</label>
                                <select id="editGoal" class="form-select">
                                    <option value="">انتخاب کنید</option>
                                    <option value="muscleGain">افزایش حجم عضلانی</option>
                                    <option value="fatLoss">چربی سوزی</option>
                                    <option value="recovery">ریکاوری بهتر</option>
                                    <option value="performance">بهبود عملکرد</option>
                                    <option value="health">سلامت عمومی</option>
                                </select>
                            </div>
                            <div class="col-md-12">
                                <label class="form-label">توضیحات</label>
                                <textarea id="editDdoso" class="form-control"></textarea>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">آدرس عکس تمام‌رخ</label>
                                <input type="url" id="editFrontPhoto" class="form-control" placeholder="https://example.com/photo.jpg">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">آدرس عکس نیم‌رخ</label>
                                <input type="url" id="editSidePhoto" class="form-control" placeholder="https://example.com/photo.jpg">
                            </div>
                        </form>
                        <button type="button" class="btn btn-primary mt-2" onclick="saveEditedUser()">
                            <i class="ti ti-check me-1"></i> ذخیره
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Notebook Modal -->
        <div class="modal fade" id="notebookModal" tabindex="-1">
            <div class="modal-dialog modal-xl">
                <div class="modal-content notebook-content">
                    <div class="modal-header">
                        <h5 class="modal-title">برنامه تمرینی</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="editor-toolbar mb-3">
                            <button class="btn btn-sm btn-outline-secondary" onclick="addHeading(1)">H1</button>
                            <button class="btn btn-sm btn-outline-secondary" onclick="addHeading(2)">H2</button>
                            <button class="btn btn-sm btn-outline-secondary" onclick="addHeading(3)">H3</button>
                            <button class="btn btn-sm btn-outline-secondary" onclick="addText()">متن</button>
                            <button class="btn btn-sm btn-outline-secondary" onclick="addLink()">لینک</button>
                            <button class="btn btn-sm btn-outline-secondary" onclick="addTable()">جدول</button>
                            <button class="btn btn-sm btn-outline-secondary" onclick="addImage()">تصویر</button>
                            <button class="btn btn-sm btn-primary" onclick="saveProgram()">ذخیره</button>
                        </div>
                        <div id="editor"></div>
                        <div class="print-controls mt-3">
                            <div class="page-nav">
                                <button class="btn btn-sm btn-outline-secondary" onclick="navigatePage(-1)">
                                    <i class="ti ti-chevron-right"></i>
                                </button>
                                <span class="page-number" id="pageNumber">1</span>
                                <button class="btn btn-sm btn-outline-secondary" onclick="navigatePage(1)">
                                    <i class="ti ti-chevron-left"></i>
                                </button>
                            </div>
                            <button class="btn btn-sm btn-outline-secondary" onclick="addPage()">
                                <i class="ti ti-plus me-1"></i> افزودن صفحه
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="deletePage()">
                                <i class="ti ti-trash me-1"></i> حذف صفحه
                            </button>
                            <button class="btn btn-sm btn-primary" onclick="printProgram()">
                                <i class="ti ti-printer me-1"></i> چاپ
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tabler/core@1.0.0-beta17/dist/js/tabler.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/quill@2.0.2/dist/quill.min.js"></script>
    <script>
        // Initialize Quill
        if (typeof Quill === 'undefined') {
            console.error('Quill.js failed to load. Please check the CDN link or internet connection.');
            showAlert('danger', 'خطا در بارگذاری Quill.js. لطفاً اتصال اینترنت یا لینک CDN را بررسی کنید.');
        } else {
            const quill = new Quill('#editor', { theme: 'snow', direction: 'rtl' });
            let usersData = [];
            let currentProgramUser = null;
            let currentUserIndex = null;
            let pages = [];
            let currentPage = 0;

            // Default Values
            const defaultValues = {
                firstName: '-',
                lastName: '-',
                birthDate: '-',
                phone: '-',
                contactMethod: '-',
                gender: '-',
                weight: '-',
                height: '-',
                thigh: '-',
                abdomen: '-',
                hip: '-',
                chest: '-',
                arm: '-',
                q1: false,
                heartDetails: '-',
                supplement1: false,
                otherSupplement: '-',
                wantSupplementInfo: false,
                wantToPurchase: false,
                budget: '-',
                goal: '-',
                ddoso: '-',
                frontPhoto: 'https://via.placeholder.com/200',
                sidePhoto: 'https://via.placeholder.com/200'
            };

            // Show Alert
            function showAlert(type, message) {
                const alert = $(`
                    <div class="alert alert-${type} alert-dismissible" role="alert">
                        <div>${message}</div>
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                `);
                $('body').append(alert);
                setTimeout(() => alert.alert('close'), 5000);
            }

            // Toggle Dark Mode
            function toggleDarkMode() {
                $('body').toggleClass('dark-mode');
                const isDark = $('body').hasClass('dark-mode');
                localStorage.setItem('darkMode', isDark);
                $('#toggleDarkMode').html(isDark ? '<i class="ti ti-sun me-1"></i> حالت روشن' : '<i class="ti ti-moon me-1"></i> حالت تاریک');
            }

            // Load Dark Mode
            function loadDarkMode() {
                if (localStorage.getItem('darkMode') === 'true') {
                    $('body').addClass('dark-mode');
                    $('#toggleDarkMode').html('<i class="ti ti-sun me-1"></i> حالت روشن');
                }
            }

            // Load Data
            function loadData() {
                try {
                    usersData = JSON.parse(localStorage.getItem('usersData')) || [];
                    loadTable();
                } catch (e) {
                    console.error('Error loading data:', e);
                    showAlert('danger', 'خطا در بارگذاری داده‌ها.');
                    usersData = [];
                    loadTable();
                }
            }

            // Load Table
            function loadTable(data = usersData) {
                const $tableBody = $('#tableBody');
                $tableBody.empty();
                if (data.length === 0) {
                    $tableBody.append('<tr><td colspan="6">هیچ کاربری وجود ندارد.</td></tr>');
                    return;
                }
                data.forEach((user, index) => {
                    $tableBody.append(`
                        <tr>
                            <td>${index + 1}</td>
                            <td>${user.firstName} ${user.lastName}</td>
                            <td>${user.phone}</td>
                            <td>${user.contactMethod}</td>
                            <td>${user.requestDate}</td>
                            <td>
                                <button class="btn btn-sm btn-primary" onclick="showDetails(${index})">
                                    <i class="ti ti-info-circle me-1"></i> اطلاعات بیشتر
                                </button>
                            </td>
                        </tr>
                    `);
                });
                localStorage.setItem('usersData', JSON.stringify(usersData));
            }

            // Search Functionality
            function searchUsers() {
                $('#searchInput').on('input', function() {
                    const query = $(this).val().toLowerCase();
                    const filteredData = usersData.filter(user =>
                        `${user.firstName} ${user.lastName}`.toLowerCase().includes(query) ||
                        user.phone.includes(query)
                    );
                    loadTable(filteredData);
                });
            }

            // Add Data from Textarea
            function addDataFromTextarea() {
                $('#addDataBtn').click(function() {
                    try {
                        const text = $('#addTextarea').val();
                        const lines = text.trim().split('\n');
                        const newUser = { ...defaultValues, requestDate: new Date().toLocaleString('fa-IR') };
                        for (let i = 0; i < lines.length; i += 2) {
                            const key = lines[i].trim();
                            const value = lines[i + 1] ? lines[i + 1].trim() : '';
                            if (key in defaultValues) {
                                if (key === 'q1' || key === 'supplement1' || key === 'wantSupplementInfo' || key === 'wantToPurchase') {
                                    newUser[key] = value.toLowerCase() === 'true';
                                } else {
                                    newUser[key] = value || defaultValues[key];
                                }
                            }
                        }
                        usersData.push(newUser);
                        localStorage.setItem('usersData', JSON.stringify(usersData));
                        loadTable();
                        $('#addModal').modal('hide');
                        $('#addTextarea').val('');
                        showAlert('success', 'کاربر با موفقیت اضافه شد.');
                    } catch (e) {
                        showAlert('danger', 'خطا در افزودن داده‌ها. لطفاً فرمت متن را بررسی کنید.');
                        console.error('Error adding data:', e);
                    }
                });
            }

            // Add Data from Form
            function addDataFromForm() {
                $('#addFormBtn').click(function() {
                    try {
                        const newUser = {
                            firstName: $('#addFirstName').val() || defaultValues.firstName,
                            lastName: $('#addLastName').val() || defaultValues.lastName,
                            birthDate: $('#addBirthDate').val() || defaultValues.birthDate,
                            phone: $('#addPhone').val() || defaultValues.phone,
                            contactMethod: $('#addContactMethod').val() || defaultValues.contactMethod,
                            gender: $('#addGender').val() || defaultValues.gender,
                            weight: $('#addWeight').val() || defaultValues.weight,
                            height: $('#addHeight').val() || defaultValues.height,
                            thigh: $('#addThigh').val() || defaultValues.thigh,
                            abdomen: $('#addAbdomen').val() || defaultValues.abdomen,
                            hip: $('#addHip').val() || defaultValues.hip,
                            chest: $('#addChest').val() || defaultValues.chest,
                            arm: $('#addArm').val() || defaultValues.arm,
                            q1: $('#addQ1').val() === 'true',
                            heartDetails: $('#addHeartDetails').val() || defaultValues.heartDetails,
                            supplement1: $('#addSupplement1').val() === 'true',
                            otherSupplement: $('#addOtherSupplement').val() || defaultValues.otherSupplement,
                            wantSupplementInfo: $('#addWantSupplementInfo').val() === 'true',
                            wantToPurchase: $('#addWantToPurchase').val() === 'true',
                            budget: $('#addBudget').val() || defaultValues.budget,
                            goal: $('#addGoal').val() || defaultValues.goal,
                            ddoso: $('#addDdoso').val() || defaultValues.ddoso,
                            frontPhoto: $('#addFrontPhoto').val() || defaultValues.frontPhoto,
                            sidePhoto: $('#addSidePhoto').val() || defaultValues.sidePhoto,
                            requestDate: new Date().toLocaleString('fa-IR')
                        };
                        usersData.push(newUser);
                        localStorage.setItem('usersData', JSON.stringify(usersData));
                        loadTable();
                        $('#addModal').modal('hide');
                        $('#addForm')[0].reset();
                        showAlert('success', 'کاربر با موفقیت اضافه شد.');
                    } catch (e) {
                        showAlert('danger', 'خطا در افزودن کاربر.');
                        console.error('Error adding user from form:', e);
                    }
                });
            }

            // Show Details
            function showDetails(index) {
                currentUserIndex = index;
                const user = usersData[index];
                const $modalContent = $('#modalContent');
                $modalContent.html(`
                    <div><b>نام:</b> ${user.firstName}</div>
                    <div><b>نام خانوادگی:</b> ${user.lastName}</div>
                    <div><b>تاریخ تولد:</b> ${user.birthDate}</div>
                    <div><b>شماره تلفن:</b> ${user.phone}</div>
                    <div><b>متد تماس:</b> ${user.contactMethod}</div>
                    <div><b>جنسیت:</b> ${user.gender === 'male' ? 'مرد' : user.gender === 'female' ? 'زن' : '-'}</div>
                    <div><b>وزن:</b> ${user.weight} کیلوگرم</div>
                    <div><b>قد:</b> ${user.height} سانتی‌متر</div>
                    <div><b>دور ران:</b> ${user.thigh} سانتی‌متر</div>
                    <div><b>دور شکم:</b> ${user.abdomen} سانتی‌متر</div>
                    <div><b>دور باسن:</b> ${user.hip} سانتی‌متر</div>
                    <div><b>دور سینه:</b> ${user.chest} سانتی‌متر</div>
                    <div><b>دور بازو:</b> ${user.arm} سانتی‌متر</div>
                    <div><b>سابقه بیماری:</b> ${user.q1 ? 'بله' : 'خیر'}</div>
                    <div><b>جزئیات بیماری:</b> ${user.heartDetails}</div>
                    <div><b>استفاده از مکمل:</b> ${user.supplement1 ? 'بله' : 'خیر'}</div>
                    <div><b>نوع مکمل:</b> ${user.otherSupplement}</div>
                    <div><b>اطلاعات مکمل:</b> ${user.wantSupplementInfo ? 'بله' : 'خیر'}</div>
                    <div><b>قصد خرید:</b> ${user.wantToPurchase ? 'بله' : 'خیر'}</div>
                    <div><b>بودجه:</b> ${user.budget || '-'}</div>
                    <div><b>هدف:</b> ${user.goal || '-'}</div>
                    <div><b>توضیحات:</b> ${user.ddoso}</div>
                    <div><b>عکس تمام‌رخ:</b> <img src="${user.frontPhoto || defaultValues.frontPhoto}" alt="عکس تمام‌رخ"></div>
                    <div><b>عکس نیم‌رخ:</b> <img src="${user.sidePhoto || defaultValues.sidePhoto}" alt="عکس نیم‌رخ"></div>
                    <div>
                        <button class="btn btn-primary" onclick="openNotebook(${index})">
                            <i class="ti ti-notebook me-1"></i> نوشتن برنامه تمرینی
                        </button>
                    </div>
                `);
                $('#requestDate').text(user.requestDate);
                $('#detailsModal').modal('show');
            }

            // Edit User
            function editUser(index) {
                currentUserIndex = index;
                const user = usersData[index];
                $('#editFirstName').val(user.firstName === '-' ? '' : user.firstName);
                $('#editLastName').val(user.lastName === '-' ? '' : user.lastName);
                $('#editBirthDate').val(user.birthDate === '-' ? '' : user.birthDate);
                $('#editPhone').val(user.phone === '-' ? '' : user.phone);
                $('#editContactMethod').val(user.contactMethod === '-' ? '' : user.contactMethod);
                $('#editGender').val(user.gender === '-' ? '' : user.gender);
                $('#editWeight').val(user.weight === '-' ? '' : user.weight);
                $('#editHeight').val(user.height === '-' ? '' : user.height);
                $('#editThigh').val(user.thigh === '-' ? '' : user.thigh);
                $('#editAbdomen').val(user.abdomen === '-' ? '' : user.abdomen);
                $('#editHip').val(user.hip === '-' ? '' : user.hip);
                $('#editChest').val(user.chest === '-' ? '' : user.chest);
                $('#editArm').val(user.arm === '-' ? '' : user.arm);
                $('#editQ1').val(user.q1.toString());
                $('#editHeartDetails').val(user.heartDetails === '-' ? '' : user.heartDetails);
                $('#editSupplement1').val(user.supplement1.toString());
                $('#editOtherSupplement').val(user.otherSupplement === '-' ? '' : user.otherSupplement);
                $('#editWantSupplementInfo').val(user.wantSupplementInfo.toString());
                $('#editWantToPurchase').val(user.wantToPurchase.toString());
                $('#editBudget').val(user.budget === '-' ? '' : user.budget);
                $('#editGoal').val(user.goal === '-' ? '' : user.goal);
                $('#editDdoso').val(user.ddoso === '-' ? '' : user.ddoso);
                $('#editFrontPhoto').val(user.frontPhoto === defaultValues.frontPhoto ? '' : user.frontPhoto);
                $('#editSidePhoto').val(user.sidePhoto === defaultValues.sidePhoto ? '' : user.sidePhoto);
                $('#detailsModal').modal('hide');
                $('#editModal').modal('show');
            }

            // Save Edited User
            function saveEditedUser() {
                try {
                    const user = usersData[currentUserIndex];
                    user.firstName = $('#editFirstName').val() || defaultValues.firstName;
                    user.lastName = $('#editLastName').val() || defaultValues.lastName;
                    user.birthDate = $('#editBirthDate').val() || defaultValues.birthDate;
                    user.phone = $('#editPhone').val() || defaultValues.phone;
                    user.contactMethod = $('#editContactMethod').val() || defaultValues.contactMethod;
                    user.gender = $('#editGender').val() || defaultValues.gender;
                    user.weight = $('#editWeight').val() || defaultValues.weight;
                    user.height = $('#editHeight').val() || defaultValues.height;
                    user.thigh = $('#editThigh').val() || defaultValues.thigh;
                    user.abdomen = $('#editAbdomen').val() || defaultValues.abdomen;
                    user.hip = $('#editHip').val() || defaultValues.hip;
                    user.chest = $('#editChest').val() || defaultValues.chest;
                    user.arm = $('#editArm').val() || defaultValues.arm;
                    user.q1 = $('#editQ1').val() === 'true';
                    user.heartDetails = $('#editHeartDetails').val() || defaultValues.heartDetails;
                    user.supplement1 = $('#editSupplement1').val() === 'true';
                    user.otherSupplement = $('#editOtherSupplement').val() || defaultValues.otherSupplement;
                    user.wantSupplementInfo = $('#editWantSupplementInfo').val() === 'true';
                    user.wantToPurchase = $('#editWantToPurchase').val() === 'true';
                    user.budget = $('#editBudget').val() || defaultValues.budget;
                    user.goal = $('#editGoal').val() || defaultValues.goal;
                    user.ddoso = $('#editDdoso').val() || defaultValues.ddoso;
                    user.frontPhoto = $('#editFrontPhoto').val() || defaultValues.frontPhoto;
                    user.sidePhoto = $('#editSidePhoto').val() || defaultValues.sidePhoto;
                    localStorage.setItem('usersData', JSON.stringify(usersData));
                    loadTable();
                    $('#editModal').modal('hide');
                    showDetails(currentUserIndex);
                    showAlert('success', 'کاربر با موفقیت ویرایش شد.');
                } catch (e) {
                    showAlert('danger', 'خطا در ذخیره تغییرات.');
                    console.error('Error saving edited user:', e);
                }
            }

            // Delete User
            function deleteUser(index) {
                if (confirm('آیا مطمئن هستید که می‌خواهید این کاربر را حذف کنید؟')) {
                    try {
                        usersData.splice(index, 1);
                        localStorage.setItem('usersData', JSON.stringify(usersData));
                        localStorage.removeItem(`program_${index}`);
                        loadTable();
                        $('#detailsModal').modal('hide');
                        showAlert('success', 'کاربر با موفقیت حذف شد.');
                    } catch (e) {
                        showAlert('danger', 'خطا در حذف کاربر.');
                        console.error('Error deleting user:', e);
                    }
                }
            }

            // Open Notebook
            function openNotebook(index) {
                try {
                    currentProgramUser = index;
                    pages = JSON.parse(localStorage.getItem(`program_${index}`)) || [new Quill.Delta()];
                    currentPage = 0;
                    quill.setContents(pages[currentPage] || '');
                    $('#pageNumber').text(currentPage + 1);
                    $('#notebookModal').modal('show');
                } catch (e) {
                    showAlert('danger', 'خطا در باز کردن نوت‌بوک.');
                    console.error('Error opening notebook:', e);
                }
            }

            // Add Heading
            function addHeading(level) {
                quill.format('header', level);
            }

            // Add Text
            function addText() {
                quill.insertText(quill.getSelection()?.index || 0, 'متن نمونه');
            }

            // Add Link
            function addLink() {
                const url = prompt('لینک را وارد کنید:');
                if (url) quill.insertText(quill.getSelection()?.index || 0, url, { link: url });
            }

            // Add Table
            function addTable() {
                const rows = prompt('تعداد ردیف‌ها را وارد کنید:', '2');
                const cols = prompt('تعداد ستون‌ها را وارد کنید:', '2');
                if (rows && cols && !isNaN(rows) && !isNaN(cols)) {
                    let html = '<table border="1"><tr>';
                    for (let i = 0; i < cols; i++) html += '<th>عنوان</th>';
                    html += '</tr>';
                    for (let i = 0; i < rows - 1; i++) {
                        html += '<tr>';
                        for (let j = 0; j < cols; j++) html += '<td>توضیح</td>';
                        html += '</tr>';
                    }
                    html += '</table>';
                    quill.clipboard.dangerouslyPasteHTML(quill.getSelection()?.index || 0, html);
                } else {
                    showAlert('warning', 'لطفاً تعداد معتبر برای ردیف و ستون وارد کنید.');
                }
            }

            // Add Image
            function addImage() {
                const url = prompt('آدرس تصویر را وارد کنید:');
                if (url) quill.insertEmbed(quill.getSelection()?.index || 0, 'image', url);
            }

            // Save Program
            function saveProgram() {
                try {
                    pages[currentPage] = quill.getContents();
                    localStorage.setItem(`program_${currentProgramUser}`, JSON.stringify(pages));
                    showAlert('success', 'برنامه با موفقیت ذخیره شد.');
                } catch (e) {
                    showAlert('danger', 'خطا در ذخیره برنامه.');
                    console.error('Error saving program:', e);
                }
            }

            // Navigate Page
            function navigatePage(direction) {
                try {
                    pages[currentPage] = quill.getContents();
                    currentPage = Math.max(0, Math.min(pages.length - 1, currentPage + direction));
                    quill.setContents(pages[currentPage] || '');
                    $('#pageNumber').text(currentPage + 1);
                } catch (e) {
                    showAlert('danger', 'خطا در جابجایی صفحه.');
                    console.error('Error navigating page:', e);
                }
            }

            // Add Page
            function addPage() {
                try {
                    pages[currentPage] = quill.getContents();
                    pages.push(new Quill.Delta());
                    currentPage = pages.length - 1;
                    quill.setContents(pages[currentPage]);
                    $('#pageNumber').text(currentPage + 1);
                    showAlert('success', 'صفحه جدید اضافه شد.');
                } catch (e) {
                    showAlert('danger', 'خطا در افزودن صفحه.');
                    console.error('Error adding page:', e);
                }
            }

            // Delete Page
            function deletePage() {
                if (pages.length <= 1) {
                    showAlert('warning', 'نمی‌توانید تنها صفحه را حذف کنید!');
                    return;
                }
                if (confirm('آیا مطمئن هستید که می‌خواهید این صفحه را حذف کنید؟')) {
                    try {
                        pages.splice(currentPage, 1);
                        currentPage = Math.min(currentPage, pages.length - 1);
                        quill.setContents(pages[currentPage] || '');
                        $('#pageNumber').text(currentPage + 1);
                        localStorage.setItem(`program_${currentProgramUser}`, JSON.stringify(pages));
                        showAlert('success', 'صفحه با موفقیت حذف شد.');
                    } catch (e) {
                        showAlert('danger', 'خطا در حذف صفحه.');
                        console.error('Error deleting page:', e);
                    }
                }
            }

            // Print Program
            function printProgram() {
                try {
                    const printAll = confirm('آیا تمام صفحات پرینت شود؟');
                    let content = '';
                    if (printAll) {
                        pages.forEach(page => {
                            content += `<div class="page">${quill.root.innerHTML}</div>`;
                        });
                    } else {
                        content = quill.root.innerHTML;
                    }
                    const printWindow = window.open('', '_blank');
                    printWindow.document.write(`
                        <html><head><style>body { font-family: Arial, sans-serif; text-align: right; } .page { page-break-after: always; }</style></head><body>${content}</body></html>
                    `);
                    printWindow.document.close();
                    printWindow.print();
                    showAlert('success', 'برنامه آماده چاپ است.');
                } catch (e) {
                    showAlert('danger', 'خطا در چاپ برنامه.');
                    console.error('Error printing program:', e);
                }
            }

            // Settings
            function settings() {
                $('#settingsBtn').click(function() {
                    showAlert('info', 'تنظیمات هنوز پیاده‌سازی نشده است.');
                });
            }

            // Initialize
            $(document).ready(function() {
                loadData();
                loadDarkMode();
                searchUsers();
                addDataFromTextarea();
                addDataFromForm();
                settings();
                $('#toggleDarkMode').click(toggleDarkMode);
            });
        }
    </script>
</body>
</html>
